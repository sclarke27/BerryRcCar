/*!
  * SWIM Library - CLIENT
  * Version: 0.7.2
  * Copyright Â© 2015-2018 SWIM Inc. All Rights Reserved
  * Website: https://www.swim.ai
  * Date: Thu Aug 23 2018 13:16:49 GMT-0700 (DST)
*/
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("@swim/recon")):"function"==typeof define&&define.amd?define(["exports","@swim/recon"],e):e(t.swim={},t.recon)}(this,function(t,y){"use strict";var o=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])};function h(t,e){function i(){this.constructor=t}o(t,e),t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)}var e,i,r=function(){function e(){}return Object.defineProperty(e.prototype,"tag",{get:function(){return this.constructor.tag},enumerable:!0,configurable:!0}),e.prototype.prio=function(t){return void 0===t?0:this},e.prototype.rate=function(t){return void 0===t?0:this},e.prototype.toRecon=function(){return this.toValue().toRecon()},Object.defineProperty(e,"tag",{get:function(){return""},enumerable:!0,configurable:!0}),e.fromValue=function(t){switch(t.tag){case"event":return a.fromValue(t);case"command":return d.fromValue(t);case"link":return u.fromValue(t);case"linked":return p.fromValue(t);case"sync":return c.fromValue(t);case"synced":return f.fromValue(t);case"unlink":return _.fromValue(t);case"unlinked":return v.fromValue(t);case"auth":return m.fromValue(t);case"authed":return w.fromValue(t);case"deauth":return g.fromValue(t);case"deauthed":return k.fromValue(t);default:return}},e.parseRecon=function(t){return e.fromValue(y.Value.parseRecon(t))},e}(),n=function(i){function t(t){var e=i.call(this)||this;return e._body=t,e}return h(t,i),t.prototype.node=function(t){return void 0===t?y.Uri.Empty:this},t.prototype.lane=function(t){return void 0===t?y.Uri.Empty:this},t.prototype.body=function(t){return void 0===t?this._body:(t=y.Value.fromAny(t),this.copy(t))},t.prototype.toValue=function(){return y.Attr.of(this.tag).concat(this._body)},t.fromValue=function(t,e){if(t.header(e.tag).isDefined())return new e(t.body())},t}(r),s=function(n){function t(t,e,i){var o=n.call(this)||this;return o._node=t,o._lane=e,o._body=i,o}return h(t,n),t.prototype.node=function(t){return void 0===t?this._node:(t=y.Uri.fromAny(t),this.copy(t,this._lane,this._body))},t.prototype.lane=function(t){return void 0===t?this._lane:(t=y.Uri.fromAny(t),this.copy(this._node,t,this._body))},t.prototype.body=function(t){return void 0===t?this._body:(t=y.Value.fromAny(t),this.copy(this._node,this._lane,t))},t.prototype.toValue=function(){var t=y.Record.empty(2).slot("node",this._node.toUri()).slot("lane",this._lane.toUri());return y.Attr.of(this.tag,t).concat(this._body)},t.fromValue=function(t,e){var o,n;if(t.header(e.tag).forEach(function(t,e){if(t.key instanceof y.Text){var i=t.key.value;"node"===i?o=t.cast(y.Form.Uri,o):"lane"===i&&(n=t.cast(y.Form.Uri,n))}else t instanceof y.Value&&(0===e?o=t.cast(y.Form.Uri,o):1===e&&(n=t.cast(y.Form.Uri,n)))},this),o&&n){var i=t.body();return new e(o,n,i)}},t}(r),l=function(s){function t(t,e,i,o,n){var r=s.call(this)||this;return r._node=t,r._lane=e,r._prio=i,r._rate=o,r._body=n,r}return h(t,s),t.prototype.node=function(t){return void 0===t?this._node:(t=y.Uri.fromAny(t),this.copy(t,this._lane,this._prio,this._rate,this._body))},t.prototype.lane=function(t){return void 0===t?this._lane:(t=y.Uri.fromAny(t),this.copy(this._node,t,this._prio,this._rate,this._body))},t.prototype.prio=function(t){return void 0===t?this._prio:this.copy(this._node,this._lane,t,this._rate,this._body)},t.prototype.rate=function(t){return void 0===t?this._rate:this.copy(this._node,this._lane,this._prio,t,this._body)},t.prototype.body=function(t){return void 0===t?this._body:(t=y.Value.fromAny(t),this.copy(this._node,this._lane,this._prio,this._rate,t))},t.prototype.toValue=function(){var t=y.Record.empty(4).slot("node",this._node.toUri()).slot("lane",this._lane.toUri());return this._prio&&t.slot("prio",this._prio),this._rate&&t.slot("rate",this._rate),y.Attr.of(this.tag,t).concat(this._body)},t.fromValue=function(t,e){var o,n,r=0,s=0;if(t.header(e.tag).forEach(function(t,e){if(t.key instanceof y.Text){var i=t.key.value;"node"===i?o=t.cast(y.Form.Uri,o):"lane"===i?n=t.cast(y.Form.Uri,n):"prio"===i?r=t.numberValue(r):"rate"===i&&(s=t.numberValue(s))}else t instanceof y.Value&&(0===e?o=t.cast(y.Form.Uri,o):1===e&&(n=t.cast(y.Form.Uri,n)))},this),o&&n){var i=t.body();return new e(o,n,r,s,i)}},t}(r),a=function(o){function n(t,e,i){return o.call(this,t,e,i)||this}return h(n,o),n.prototype.copy=function(t,e,i){return new n(t,e,i)},n.fromValue=function(t){return s.fromValue(t,n)},Object.defineProperty(n,"tag",{get:function(){return"event"},enumerable:!0,configurable:!0}),n.of=function(t,e,i){return void 0===i&&(i=y.Value.Absent),new n(t=y.Uri.fromAny(t),e=y.Uri.fromAny(e),i=y.Value.fromAny(i))},n}(s),d=function(o){function n(t,e,i){return o.call(this,t,e,i)||this}return h(n,o),n.prototype.copy=function(t,e,i){return new n(t,e,i)},n.fromValue=function(t){return s.fromValue(t,n)},Object.defineProperty(n,"tag",{get:function(){return"command"},enumerable:!0,configurable:!0}),n.of=function(t,e,i){return void 0===i&&(i=y.Value.Absent),new n(t=y.Uri.fromAny(t),e=y.Uri.fromAny(e),i=y.Value.fromAny(i))},n}(s),u=function(r){function s(t,e,i,o,n){return r.call(this,t,e,i,o,n)||this}return h(s,r),s.prototype.copy=function(t,e,i,o,n){return new s(t,e,i,o,n)},s.fromValue=function(t){return l.fromValue(t,s)},Object.defineProperty(s,"tag",{get:function(){return"link"},enumerable:!0,configurable:!0}),s.of=function(t,e,i,o,n){return void 0===i&&(i=0),void 0===o&&(o=0),void 0===n&&(n=y.Value.Absent),new s(t=y.Uri.fromAny(t),e=y.Uri.fromAny(e),i,o,n=y.Value.fromAny(n))},s}(l),p=function(r){function s(t,e,i,o,n){return r.call(this,t,e,i,o,n)||this}return h(s,r),s.prototype.copy=function(t,e,i,o,n){return new s(t,e,i,o,n)},s.fromValue=function(t){return l.fromValue(t,s)},Object.defineProperty(s,"tag",{get:function(){return"linked"},enumerable:!0,configurable:!0}),s.of=function(t,e,i,o,n){return void 0===i&&(i=0),void 0===o&&(o=0),void 0===n&&(n=y.Value.Absent),new s(t=y.Uri.fromAny(t),e=y.Uri.fromAny(e),i,o,n=y.Value.fromAny(n))},s}(l),c=function(r){function s(t,e,i,o,n){return r.call(this,t,e,i,o,n)||this}return h(s,r),s.prototype.copy=function(t,e,i,o,n){return new s(t,e,i,o,n)},s.fromValue=function(t){return l.fromValue(t,s)},Object.defineProperty(s,"tag",{get:function(){return"sync"},enumerable:!0,configurable:!0}),s.of=function(t,e,i,o,n){return void 0===i&&(i=0),void 0===o&&(o=0),void 0===n&&(n=y.Value.Absent),new s(t=y.Uri.fromAny(t),e=y.Uri.fromAny(e),i,o,n=y.Value.fromAny(n))},s}(l),f=function(o){function n(t,e,i){return o.call(this,t,e,i)||this}return h(n,o),n.prototype.copy=function(t,e,i){return new n(t,e,i)},n.fromValue=function(t){return s.fromValue(t,n)},Object.defineProperty(n,"tag",{get:function(){return"synced"},enumerable:!0,configurable:!0}),n.of=function(t,e,i){return void 0===i&&(i=y.Value.Absent),new n(t=y.Uri.fromAny(t),e=y.Uri.fromAny(e),i=y.Value.fromAny(i))},n}(s),_=function(o){function n(t,e,i){return o.call(this,t,e,i)||this}return h(n,o),n.prototype.copy=function(t,e,i){return new n(t,e,i)},n.fromValue=function(t){return s.fromValue(t,n)},Object.defineProperty(n,"tag",{get:function(){return"unlink"},enumerable:!0,configurable:!0}),n.of=function(t,e,i){return void 0===i&&(i=y.Value.Absent),new n(t=y.Uri.fromAny(t),e=y.Uri.fromAny(e),i=y.Value.fromAny(i))},n}(s),v=function(o){function n(t,e,i){return o.call(this,t,e,i)||this}return h(n,o),n.prototype.copy=function(t,e,i){return new n(t,e,i)},n.fromValue=function(t){return s.fromValue(t,n)},Object.defineProperty(n,"tag",{get:function(){return"unlinked"},enumerable:!0,configurable:!0}),n.of=function(t,e,i){return void 0===i&&(i=y.Value.Absent),new n(t=y.Uri.fromAny(t),e=y.Uri.fromAny(e),i=y.Value.fromAny(i))},n}(s),m=function(e){function i(t){return e.call(this,t)||this}return h(i,e),i.prototype.copy=function(t){return new i(t)},i.fromValue=function(t){return n.fromValue(t,i)},Object.defineProperty(i,"tag",{get:function(){return"auth"},enumerable:!0,configurable:!0}),i.of=function(t){return void 0===t&&(t=y.Value.Absent),new i(t=y.Value.fromAny(t))},i}(n),w=function(e){function i(t){return e.call(this,t)||this}return h(i,e),i.prototype.copy=function(t){return new i(t)},i.fromValue=function(t){return n.fromValue(t,i)},Object.defineProperty(i,"tag",{get:function(){return"authed"},enumerable:!0,configurable:!0}),i.of=function(t){return void 0===t&&(t=y.Value.Absent),new i(t=y.Value.fromAny(t))},i}(n),g=function(e){function i(t){return e.call(this,t)||this}return h(i,e),i.prototype.copy=function(t){return new i(t)},i.fromValue=function(t){return n.fromValue(t,i)},Object.defineProperty(i,"tag",{get:function(){return"deauth"},enumerable:!0,configurable:!0}),i.of=function(t){return void 0===t&&(t=y.Value.Absent),new i(t=y.Value.fromAny(t))},i}(n),k=function(e){function i(t){return e.call(this,t)||this}return h(i,e),i.prototype.copy=function(t){return new i(t)},i.fromValue=function(t){return n.fromValue(t,i)},Object.defineProperty(i,"tag",{get:function(){return"deauthed"},enumerable:!0,configurable:!0}),i.of=function(t){return void 0===t&&(t=y.Value.Absent),new i(t=y.Value.fromAny(t))},i}(n),U=function(){function t(t,e,i){void 0===i&&(i={}),this._context=t,this._hostUri=e,this._options=i,this._downlinks=new y.BTree,this._downlinkCount=0,this._authenticated=!1,this._session=y.Value.Absent,this._uriCache=new y.UriCache(e),this._sendBuffer=[],this._reconnectTimer=0,this._reconnectTimeout=0,this._idleTimer=0,this.open=this.open.bind(this),this.checkIdle=this.checkIdle.bind(this)}return Object.defineProperty(t.prototype,"hostUri",{get:function(){return this._hostUri},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"credentials",{get:function(){return this._options.credentials||y.Value.Absent},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"maxReconnectTimeout",{get:function(){return this._options.maxReconnectTimeout||3e4},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"idleTimeout",{get:function(){return this._options.idleTimeout||1e3},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"sendBufferSize",{get:function(){return this._options.sendBufferSize||1024},enumerable:!0,configurable:!0}),t.prototype.isAuthenticated=function(){return this._authenticated},Object.defineProperty(t.prototype,"session",{get:function(){return this._session},enumerable:!0,configurable:!0}),t.prototype.isIdle=function(){return!this._sendBuffer.length&&!this._downlinkCount},t.prototype.resolve=function(t){return this._uriCache.resolve(t)},t.prototype.unresolve=function(t){return this._uriCache.unresolve(t)},t.prototype.authenticate=function(t){if(!(t=y.Value.fromAny(t)).equals(this._options.credentials))if(this._options.credentials=t,this.isConnected()){var e=m.of(t);this.push(e)}else this.open()},t.prototype.openDownlink=function(t){this.clearIdle();var e=this.resolve(t.nodeUri()),i=t.laneUri();this._downlinkCount||this.open();var o=this._downlinks.get(e);if(o||(o=new y.BTree,this._downlinks.set(e,o)),o.get(i))throw new Error("duplicate downlink");o.set(i,t),this._downlinkCount+=1,t.openUp(this),this.isConnected()&&t.hostDidConnect(this)},t.prototype.unlinkDownlink=function(t){var e=this.resolve(t.nodeUri()),i=t.laneUri(),o=this._downlinks.get(e);if(o&&o.get(i)&&this.isConnected()){var n=_.of(this.unresolve(e),i);t.onUnlinkRequest(n,this),this.push(n)}},t.prototype.closeDownlink=function(t){var e=this.resolve(t.nodeUri()),i=t.laneUri(),o=this._downlinks.get(e);o&&o.get(i)&&(this._downlinkCount-=1,o.delete(i),o.isEmpty()&&this._downlinks.delete(e),this._downlinkCount||this.watchIdle(),t.closeUp(this))},t.prototype.command=function(t,e,i){t=y.Uri.fromAny(t),t=this.resolve(t),e=y.Uri.fromAny(e),i=y.Value.fromAny(i);var o=d.of(this.unresolve(t),e,i);this.push(o)},t.prototype.onEnvelope=function(t){t instanceof a?this.onEventMessage(t):t instanceof d?this.onCommandMessage(t):t instanceof u?this.onLinkRequest(t):t instanceof p?this.onLinkedResponse(t):t instanceof c?this.onSyncRequest(t):t instanceof f?this.onSyncedResponse(t):t instanceof _?this.onUnlinkRequest(t):t instanceof v?this.onUnlinkedResponse(t):t instanceof m?this.onAuthRequest(t):t instanceof w?this.onAuthedResponse(t):t instanceof g?this.onDeauthRequest(t):t instanceof k?this.onDeauthedResponse(t):this.onUnknownEnvelope(t)},t.prototype.onEventMessage=function(t){var e=this.resolve(t.node()),i=t.lane(),o=this._downlinks.get(e);if(o){var n=o.get(i);if(n){var r=t.node(e);n.onEventMessage(r,this)}}},t.prototype.onCommandMessage=function(t){},t.prototype.onLinkRequest=function(t){},t.prototype.onLinkedResponse=function(t){var e=this.resolve(t.node()),i=t.lane(),o=this._downlinks.get(e);if(o){var n=o.get(i);if(n){var r=t.node(e);n.onLinkedResponse(r,this)}}},t.prototype.onSyncRequest=function(t){},t.prototype.onSyncedResponse=function(t){var e=this.resolve(t.node()),i=t.lane(),o=this._downlinks.get(e);if(o){var n=o.get(i);if(n){var r=t.node(e);n.onSyncedResponse(r,this)}}},t.prototype.onUnlinkRequest=function(t){},t.prototype.onUnlinkedResponse=function(t){var e=this.resolve(t.node()),i=t.lane(),o=this._downlinks.get(e);if(o){var n=o.get(i);if(n){var r=t.node(e);n.onUnlinkedResponse(r,this)}}},t.prototype.onAuthRequest=function(t){},t.prototype.onAuthedResponse=function(t){this._authenticated=!0,this._session=t.body(),this._context.hostDidAuthenticate(t.body(),this)},t.prototype.onDeauthRequest=function(t){},t.prototype.onDeauthedResponse=function(t){this._authenticated=!1,this._session=y.Value.Absent,this._context.hostDidDeauthenticate(t.body(),this)},t.prototype.onUnknownEnvelope=function(t){},t.prototype.onConnect=function(){this._reconnectTimeout=0,this._context.hostDidConnect(this),this._downlinks.forEach(function(t,e){e.forEach(function(t,e){e.hostDidConnect(this)},this)},this)},t.prototype.onDisconnect=function(){this._authenticated=!1,this._session=y.Value.Absent,this._context.hostDidDisconnect(this),this._downlinks.forEach(function(t,e){e.forEach(function(t,e){e.hostDidDisconnect(this)},this)},this)},t.prototype.onError=function(i){this._context.hostDidFail(i,this),this._downlinks.forEach(function(t,e){e.forEach(function(t,e){e.hostDidFail(i,this)},this)},this)},t.prototype.reconnect=function(){this._reconnectTimer||(this._reconnectTimeout?this._reconnectTimeout=Math.min(Math.floor(1.8*this._reconnectTimeout),this.maxReconnectTimeout):this._reconnectTimeout=Math.floor(500+1e3*Math.random()),this._reconnectTimer=setTimeout(this.open,this._reconnectTimeout))},t.prototype.clearReconnect=function(){this._reconnectTimer&&(clearTimeout(this._reconnectTimer),this._reconnectTimer=0)},t.prototype.watchIdle=function(){!this._idleTimer&&this.isConnected()&&this.isIdle()&&(this._idleTimer=setTimeout(this.checkIdle,this.idleTimeout))},t.prototype.clearIdle=function(){this._idleTimer&&(clearTimeout(this._idleTimer),this._idleTimer=0)},t.prototype.checkIdle=function(){this.isConnected()&&this.isIdle()&&this.close()},t.prototype.close=function(){this._context.closeHost(this)},t.prototype.closeUp=function(){this._downlinks.forEach(function(t,e){e.forEach(function(t,e){e.closeUp(this)},this)},this)},t}();(i=e||(e={}))[i.KeepLinked=1]="KeepLinked",i[i.KeepSynced=2]="KeepSynced",i[i.KeepLinkedSynced=3]="KeepLinkedSynced";var b=function(){function t(t,e,i,o,n,r,s){void 0===n&&(n=0),void 0===r&&(r=0),void 0===s&&(s=y.Value.Absent),this._context=t,this._hostUri=e,this._nodeUri=i,this._laneUri=o,this._prio=n,this._rate=r,this._body=s,this._views=[],this._host=null,this._status=0}return t.prototype.hostUri=function(){return this._hostUri},t.prototype.nodeUri=function(){return this._nodeUri},t.prototype.laneUri=function(){return this._laneUri},t.prototype.prio=function(){return this._prio},t.prototype.rate=function(){return this._rate},t.prototype.body=function(){return this._body},t.prototype.keepLinked=function(){for(var t=0;t<this._views.length;t+=1)if(this._views[t].keepLinked())return!0;return!1},t.prototype.keepSynced=function(){for(var t=0;t<this._views.length;t+=1)if(this._views[t].keepSynced())return!0;return!1},t.prototype.isConnected=function(){return!(!this._host||!this._host.isConnected())},t.prototype.isAuthenticated=function(){return!(!this._host||!this._host.isAuthenticated())},t.prototype.isLinked=function(){return 0!=(2&this._status)},t.prototype.isSynced=function(){return 0!=(8&this._status)},Object.defineProperty(t.prototype,"session",{get:function(){return this._host?this._host.session:y.Value.Absent},enumerable:!0,configurable:!0}),t.prototype.addDownlink=function(t){this._views.push(t)},t.prototype.removeDownlink=function(t){for(var e=0;e<this._views.length;e+=1)this._views[e]===t&&(this._views.splice(e,1),t.closeUp());0===this._views.length&&this.unlink()},t.prototype.onEventMessage=function(t,e){for(var i=0;i<this._views.length;i+=1)this._views[i].onEventMessage(t)},t.prototype.onCommandMessage=function(t){for(var e=0;e<this._views.length;e+=1)this._views[e].onCommandMessage(t)},t.prototype.onLinkRequest=function(t){this._status|=1;for(var e=0;e<this._views.length;e+=1)this._views[e].onLinkRequest(t)},t.prototype.onLinkedResponse=function(t,e){this._status=-2&this._status|2;for(var i=0;i<this._views.length;i+=1)this._views[i].onLinkedResponse(t)},t.prototype.onSyncRequest=function(t){this._status|=4;for(var e=0;e<this._views.length;e+=1)this._views[e].onSyncRequest(t)},t.prototype.onSyncedResponse=function(t,e){this._status=-5&this._status|8;for(var i=0;i<this._views.length;i+=1)this._views[i].onSyncedResponse(t)},t.prototype.onUnlinkRequest=function(t,e){this._status=-6&this._status|16;for(var i=0;i<this._views.length;i+=1)this._views[i].onUnlinkRequest(t)},t.prototype.onUnlinkedResponse=function(t,e){this._status&=-17;for(var i=0;i<this._views.length;i+=1)this._views[i].onUnlinkedResponse(t);0===this._status&&this.close()},t.prototype.hostDidConnect=function(t){for(var e=0;e<this._views.length;e+=1)this._views[e].hostDidConnect();var i,o=this._host.unresolve(this._nodeUri);this.keepSynced()?(i=c.of(o,this._laneUri,this._prio,this._rate,this._body),this.onSyncRequest(i)):(i=u.of(o,this._laneUri,this._prio,this._rate,this._body),this.onLinkRequest(i)),this._host.push(i)},t.prototype.hostDidDisconnect=function(t){for(var e=!1,i=this._status=0;i<this._views.length;i+=1){var o=this._views[i];o.hostDidDisconnect(),e=e||o.keepLinked()}e||this.close()},t.prototype.hostDidFail=function(t,e){for(var i=0;i<this._views.length;i+=1)this._views[i].hostDidFail(t)},t.prototype.command=function(t){t=y.Value.fromAny(t),this.onCommandMessage(t),this._host.command(this._nodeUri,this._laneUri,t)},t.prototype.unlink=function(){this._status=16,this._context.unlinkDownlink(this)},t.prototype.close=function(){this._context.closeDownlink(this)},t.prototype.openUp=function(t){this._host=t;for(var e=0;e<this._views.length;e+=1)this._views[e].openUp(t)},t.prototype.closeUp=function(){var t=this._views;this._views=[];for(var e=0;e<t.length;e+=1)t[e].closeUp()},t}(),D=function(){function t(t,e,i,o,n,r,s,l,h,a,d){void 0===o&&(o=y.Uri.Empty),void 0===n&&(n=y.Uri.Empty),void 0===r&&(r=y.Uri.Empty),void 0===s&&(s=0),void 0===l&&(l=0),void 0===h&&(h=y.Value.Absent),void 0===a&&(a=0),void 0===d&&(d={}),i&&(o=void 0!==i.hostUri?y.Uri.fromAny(i.hostUri):o,n=void 0!==i.nodeUri?y.Uri.fromAny(i.nodeUri):n,r=void 0!==i.laneUri?y.Uri.fromAny(i.laneUri):r,s=void 0!==i.prio?i.prio:s,l=void 0!==i.rate?i.rate:l,h=void 0!==i.body?y.Value.fromAny(i.body):h,d.onEvent=i.onEvent||d.onEvent,d.onCommand=i.onCommand||d.onCommand,d.willLink=i.willLink||d.willLink,d.didLink=i.didLink||d.didLink,d.willSync=i.willSync||d.willSync,d.didSync=i.didSync||d.didSync,d.willUnlink=i.willUnlink||d.willUnlink,d.didUnlink=i.didUnlink||d.didUnlink,d.didConnect=i.didConnect||d.didConnect,d.didDisconnect=i.didDisconnect||d.didDisconnect,d.didClose=i.didClose||d.didClose,d.didFail=i.didFail||d.didFail),this._context=t,this._owner=e,this._hostUri=o,this._nodeUri=n,this._laneUri=r,this._prio=s,this._rate=l,this._body=h,this._flags=a,this._model=void 0,this.delegate=d}return t.prototype.hostUri=function(t){return void 0===t?this._hostUri:(t=y.Uri.fromAny(t),this.copy(this._context,this._owner,t,this._nodeUri,this._laneUri,this._prio,this._rate,this._body,this._flags,this.delegate))},t.prototype.nodeUri=function(t){return void 0===t?this._nodeUri:(t=y.Uri.fromAny(t),this.copy(this._context,this._owner,this._hostUri,t,this._laneUri,this._prio,this._rate,this._body,this._flags,this.delegate))},t.prototype.laneUri=function(t){return void 0===t?this._laneUri:(t=y.Uri.fromAny(t),this.copy(this._context,this._owner,this._hostUri,this._nodeUri,t,this._prio,this._rate,this._body,this._flags,this.delegate))},t.prototype.prio=function(t){return void 0===t?this._prio:this.copy(this._context,this._owner,this._hostUri,this._nodeUri,this._laneUri,t,this._rate,this._body,this._flags,this.delegate)},t.prototype.rate=function(t){return void 0===t?this._rate:this.copy(this._context,this._owner,this._hostUri,this._nodeUri,this._laneUri,this._prio,t,this._body,this._flags,this.delegate)},t.prototype.body=function(t){return void 0===t?this._body:(t=y.Value.fromAny(t),this.copy(this._context,this._owner,this._hostUri,this._nodeUri,this._laneUri,this._prio,this._rate,t,this._flags,this.delegate))},t.prototype.keepLinked=function(t){if(void 0===t)return 0!=(1&this._flags);var e=t?1|this._flags:-2&this._flags;return this.copy(this._context,this._owner,this._hostUri,this._nodeUri,this._laneUri,this._prio,this._rate,this._body,e,this.delegate)},t.prototype.keepSynced=function(t){if(void 0===t)return 0!=(2&this._flags);var e=t?2|this._flags:-3&this._flags;return this.copy(this._context,this._owner,this._hostUri,this._nodeUri,this._laneUri,this._prio,this._rate,this._body,e,this.delegate)},t.prototype.onEvent=function(t){return void 0===t?this.delegate.onEvent||null:(this.delegate.onEvent=t||void 0,this)},t.prototype.onCommand=function(t){return void 0===t?this.delegate.onCommand||null:(this.delegate.onCommand=t||void 0,this)},t.prototype.willLink=function(t){return void 0===t?this.delegate.willLink||null:(this.delegate.willLink=t||void 0,this)},t.prototype.didLink=function(t){return void 0===t?this.delegate.didLink||null:(this.delegate.didLink=t||void 0,this)},t.prototype.willSync=function(t){return void 0===t?this.delegate.willSync||null:(this.delegate.willSync=t||void 0,this)},t.prototype.didSync=function(t){return void 0===t?this.delegate.didSync||null:(this.delegate.didSync=t||void 0,this)},t.prototype.willUnlink=function(t){return void 0===t?this.delegate.willUnlink||null:(this.delegate.willUnlink=t||void 0,this)},t.prototype.didUnlink=function(t){return void 0===t?this.delegate.didUnlink||null:(this.delegate.didUnlink=t||void 0,this)},t.prototype.didConnect=function(t){return void 0===t?this.delegate.didConnect||null:(this.delegate.didConnect=t||void 0,this)},t.prototype.didDisconnect=function(t){return void 0===t?this.delegate.didDisconnect||null:(this.delegate.didDisconnect=t||void 0,this)},t.prototype.didClose=function(t){return void 0===t?this.delegate.didClose||null:(this.delegate.didClose=t||void 0,this)},t.prototype.didFail=function(t){return void 0===t?this.delegate.didFail||null:(this.delegate.didFail=t||void 0,this)},t.prototype.isConnected=function(){return!!this._model&&this._model.isConnected()},t.prototype.isAuthenticated=function(){return!!this._model&&this._model.isAuthenticated()},t.prototype.isLinked=function(){return!!this._model&&this._model.isLinked()},t.prototype.isSynced=function(){return!!this._model&&this._model.isSynced()},t.prototype.session=function(){return this._model?this._model.session:y.Value.Absent},t.prototype.onEventMessage=function(t){this.delegate.onEvent&&this.delegate.onEvent(t.body(),this)},t.prototype.onCommandMessage=function(t){this.delegate.onCommand&&this.delegate.onCommand(t,this)},t.prototype.onLinkRequest=function(t){this.delegate.willLink&&this.delegate.willLink(this)},t.prototype.onLinkedResponse=function(t){this.delegate.didLink&&this.delegate.didLink(this)},t.prototype.onSyncRequest=function(t){this.delegate.willSync&&this.delegate.willSync(this)},t.prototype.onSyncedResponse=function(t){this.delegate.didSync&&this.delegate.didSync(this)},t.prototype.onUnlinkRequest=function(t){this.delegate.willUnlink&&this.delegate.willUnlink(this)},t.prototype.onUnlinkedResponse=function(t){this.delegate.didUnlink&&this.delegate.didUnlink(this)},t.prototype.hostDidConnect=function(){this.delegate.didConnect&&this.delegate.didConnect(this)},t.prototype.hostDidDisconnect=function(){this.delegate.didDisconnect&&this.delegate.didDisconnect(this)},t.prototype.hostDidFail=function(t){this.delegate.didFail&&this.delegate.didFail(t,this)},t.prototype.command=function(t){this._model.command(t)},t.prototype.close=function(){this._owner&&this._owner.removeDownlink(this),this._model&&this._model.removeDownlink(this)},t.prototype.openUp=function(t){},t.prototype.closeUp=function(){this.delegate.didClose&&this.delegate.didClose(this)},t.InitForm=void 0,t}(),R=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return h(e,t),Object.defineProperty(e.prototype,"tag",{get:function(){return"link"},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"unit",{get:function(){},enumerable:!0,configurable:!0}),e.prototype.mold=function(t){if(t){var e=y.Record.empty();return void 0!==t.hostUri&&e.slot("host",y.Uri.fromAny(t.hostUri).toUri()),void 0!==t.nodeUri&&e.slot("node",y.Uri.fromAny(t.nodeUri).toUri()),void 0!==t.laneUri&&e.slot("lane",y.Uri.fromAny(t.laneUri).toUri()),void 0!==t.prio&&e.slot("prio",t.prio),void 0!==t.rate&&e.slot("rate",t.rate),void 0!==t.body&&e.slot("body",t.body),void 0!==t.type&&e.slot("type",t.type),y.Record.of(y.Attr.of("link",e))}return y.Value.Absent},e.prototype.cast=function(t){var e=t.get("link");if(e.isDefined()){var i={},o=e.get("host");o.isDefined()&&(i.hostUri=o.cast(y.Form.Uri));var n=e.get("node");n.isDefined()&&(i.nodeUri=n.cast(y.Form.Uri));var r=e.get("lane");r.isDefined()&&(i.laneUri=r.cast(y.Form.Uri));var s=e.get("prio");s.isDefined()&&(i.prio=s.numberValue());var l=e.get("rate");l.isDefined()&&(i.rate=l.numberValue());var h=e.get("body");h.isDefined()&&(i.body=h);var a=e.get("type");return a.isDefined()&&(i.type=a.stringValue()),i}},e}(y.Form);D.InitForm=new R;var E=function(l){function t(t,e,i,o,n,r,s){return l.call(this,t,e,i,o,n,r,s)||this}return h(t,l),t.prototype.type=function(){return"event"},t}(b),A=function(u){function d(t,e,i,o,n,r,s,l,h,a,d){return void 0===a&&(a=1),void 0===d&&(d={}),u.call(this,t,e,i,o,n,r,s,l,h,a,d)||this}return h(d,u),d.prototype.copy=function(t,e,i,o,n,r,s,l,h,a){return new d(t,e,void 0,i,o,n,r,s,l,h,a)},d.prototype.type=function(){return"event"},d.prototype.open=function(){var t=this._laneUri;if(t.isEmpty())throw new Error("no lane");var e=this._nodeUri;if(e.isEmpty())throw new Error("no node");var i=this._hostUri;i.isEmpty()&&(i=e.base(),e=y.Uri.unresolve(i,e));var o=this._context.getDownlink(i,e,t);if(o){if(!(o instanceof E))throw new Error("downlink type mismatch");o.addDownlink(this)}else(o=new E(this._context,i,e,t,this._prio,this._rate,this._body)).addDownlink(this),this._context.openDownlink(o);return this._model=o,this._owner&&this._owner.addDownlink(this),this},d}(D),V=function(a){function t(t,e,i,o,n,r,s,l){void 0===l&&(l=new y.STree);var h=a.call(this,t,e,i,o,n,r,s)||this;return h._state=l,h}return h(t,a),t.prototype.type=function(){return"list"},t.prototype.isEmpty=function(){return this._state.isEmpty()},Object.defineProperty(t.prototype,"length",{get:function(){return this._state.length},enumerable:!0,configurable:!0}),t.prototype.get=function(t,e){return this._state.get(t,e)||y.Value.Absent},t.prototype.getEntry=function(t,e){return this._state.getEntry(t,e)},t.prototype.set=function(t,e,i){if(void 0!==i&&(t=this._state.lookup(i,t))<0)throw new RangeError(""+i);if(t<0||t>=this._state.length)throw new RangeError(""+t);e=this.listWillUpdate(t,e);var o=this._state.getEntry(t);this._state.set(t,e),this.listDidUpdate(t,e,o[1]);var n=y.Record.empty(2).slot("id",o[0]).slot("index",t);return this.command(y.Attr.of("update",n).concat(e)),this},t.prototype.insert=function(t,e,i){if(t<0||t>this._state.length)throw new RangeError(""+t);e=this.listWillInsert(t,e),this._state.insert(t,e,i);var o=this._state.getEntry(t);this.listDidInsert(t,e);var n=y.Record.empty(2).slot("id",o[0]).slot("index",t);return this.command(y.Attr.of("insert",n).concat(e)),this},t.prototype.remove=function(t,e){if(void 0!==e&&(t=this._state.lookup(e,t))<0)throw new RangeError(""+e);if(t<0||t>this._state.length)throw new RangeError(""+t);this.listWillRemove(t);var i=this._state.getEntry(t);this._state.remove(t),this.listDidRemove(t,i[1]);var o=y.Record.empty(2).slot("id",i[0]).slot("index",t);return this.command(y.Record.empty(1).attr("remove",o)),this},t.prototype.push=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];for(var i=0;i<t.length;i+=1){var o=this._state.length+i,n=this.listWillInsert(o,t[i]);this._state.insert(o,n);var r=this._state.getEntry(o);this.listDidInsert(o,n);var s=y.Record.empty(2).slot("id",r[0]).slot("index",o);this.command(y.Attr.of("insert",s).concat(n))}return this._state.length},t.prototype.pop=function(){var t=this._state.length-1;if(0<=t){this.listWillRemove(t);var e=this._state.getEntry(t);this._state.remove(t),this.listDidRemove(t,e[1]);var i=y.Record.empty(2).slot("id",e[0]).slot("index",t);return this.command(y.Record.empty(1).attr("remove",i)),e[1]}return y.Value.Absent},t.prototype.unshift=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];for(var i=t.length-1;0<=i;i-=1){var o=this.listWillInsert(0,t[i]);this._state.insert(0,o);var n=this._state.getEntry(0);this.listDidInsert(0,o);var r=y.Record.empty(2).slot("id",n[0]).slot("index",0);this.command(y.Attr.of("insert",r).concat(o))}return this._state.length},t.prototype.shift=function(){if(0<this._state.length){this.listWillRemove(0);var t=this._state.getEntry(0);this._state.remove(0),this.listDidRemove(0,t[1]);var e=y.Record.empty(2).slot("id",t[0]).slot("index",0);return this.command(y.Record.empty(1).attr("remove",e)),t[1]}return y.Value.Absent},t.prototype.move=function(t,e,i){if(void 0!==i&&(t=this._state.lookup(i,t))<0)throw new RangeError(""+i);if(t<0||t>=this._state.length)throw new RangeError(""+t);if(e<0||e>=this._state.length)throw new RangeError(""+e);if(t!==e){var o=this._state.getEntry(t);this.listWillMove(t,e,o[1]),this._state.remove(t).insert(e,o[1],o[0]),this.listDidMove(t,e,o[1]);var n=y.Record.empty(2).slot("id",o[0]).slot("from",t).slot("to",e);this.command(y.Record.empty(1).attr("move",n))}return this},t.prototype.splice=function(t,e){for(var i=[],o=2;o<arguments.length;o++)i[o-2]=arguments[o];t<0&&(t=this._state.length+t),t=Math.min(Math.max(0,t),this._state.length),void 0===e&&(e=this._state.length-t);for(var n=[],r=t,s=t+e;r<s;r+=1){this.listWillRemove(t);var l=this._state.getEntry(t);n.push(l[1]),this._state.remove(t),this.listDidRemove(t,l[1]);var h=y.Record.empty(2).slot("id",l[0]).slot("index",t);this.command(y.Record.empty(1).attr("remove",h))}for(r=0;r<i.length;r+=1){var a=t+r,d=this.listWillInsert(a,i[r]);this._state.insert(a,d);var u=this._state.getEntry(a);this.listDidInsert(a,d);h=y.Record.empty(2).slot("id",u[0]).slot("index",a);this.command(y.Attr.of("insert",h).concat(d))}return n},t.prototype.clear=function(){this.listWillClear(),this._state.clear(),this.listDidClear(),this.command(y.Record.empty(1).attr("clear"))},t.prototype.forEach=function(n,r){return this._state.forEach(function(t,e,i,o){return n.call(r,t,e,this,o)},this)},t.prototype.values=function(){return this._state.values()},t.prototype.keys=function(){return this._state.keys()},t.prototype.entries=function(){return this._state.entries()},t.prototype.snapshot=function(){return this._state.clone()},t.prototype.setState=function(t){this._state=t},t.prototype.onEventMessage=function(t,e){a.prototype.onEventMessage.call(this,t,e);var i=t.body(),o=i.tag;if("update"===o){var n=i.head().toValue();0<=(r=this._state.lookup(n.get("id"),n.get("index").numberValue()))?this.onUpdateEvent(r,i.body(),n.get("id")):this.onInsertEvent(n.get("index").numberValue(0),i.body(),n.get("id"))}else if("insert"===o){n=i.head().toValue();(r=this._state.lookup(n.get("id"),n.get("index").numberValue()))<0?this.onInsertEvent(n.get("index").numberValue(0),i.body(),n.get("id")):this.onUpdateEvent(r,i.body(),n.get("id"))}else if("move"===o){n=i.head().toValue();0<=(r=this._state.lookup(n.get("id"),n.get("from").numberValue()))&&this.onMoveEvent(r,n.get("to").numberValue(0),n.get("id"))}else if("remove"===o){var r;n=i.head().toValue();0<=(r=this._state.lookup(n.get("id"),n.get("index").numberValue()))&&this.onRemoveEvent(r,n.get("id"))}else if("drop"===o){n=i.head();this.onDropEvent(n.numberValue(0))}else if("take"===o){n=i.head();this.onTakeEvent(n.numberValue(0))}else"clear"===o&&this.onClearEvent()},t.prototype.onUpdateEvent=function(t,e,i){e=this.listWillUpdate(t,e);var o=this._state.get(t)||y.Value.Absent;this._state.set(t,e),this.listDidUpdate(t,e,o)},t.prototype.onInsertEvent=function(t,e,i){e=this.listWillInsert(t,e),this._state.insert(t,e,i),this.listDidInsert(t,e)},t.prototype.onMoveEvent=function(t,e,i){if(t!==(e=Math.min(Math.max(0,e),this._state.length))){var o=this._state.get(t)||y.Value.Absent;this.listWillMove(t,e,o),this._state.remove(t).insert(e,o,i),this.listDidMove(t,e,o)}},t.prototype.onRemoveEvent=function(t,e){this.listWillRemove(t);var i=this._state.get(t)||y.Value.Absent;this._state.remove(t),this.listDidRemove(t,i)},t.prototype.onDropEvent=function(t){this.listWillDrop(t),this._state.drop(t),this.listDidDrop(t)},t.prototype.onTakeEvent=function(t){this.listWillTake(t),this._state.take(t),this.listDidTake(t)},t.prototype.onClearEvent=function(){this.listWillClear(),this._state.clear(),this.listDidClear()},t.prototype.listWillInsert=function(t,e){for(var i=0;i<this._views.length;i+=1)e=this._views[i].listWillInsert(t,e);return e},t.prototype.listDidInsert=function(t,e){for(var i=0;i<this._views.length;i+=1)this._views[i].listDidInsert(t,e)},t.prototype.listWillUpdate=function(t,e){for(var i=0;i<this._views.length;i+=1)e=this._views[i].listWillUpdate(t,e);return e},t.prototype.listDidUpdate=function(t,e,i){for(var o=0;o<this._views.length;o+=1)this._views[o].listDidUpdate(t,e,i)},t.prototype.listWillMove=function(t,e,i){for(var o=0;o<this._views.length;o+=1)this._views[o].listWillMove(t,e,i)},t.prototype.listDidMove=function(t,e,i){for(var o=0;o<this._views.length;o+=1)this._views[o].listDidMove(t,e,i)},t.prototype.listWillRemove=function(t){for(var e=0;e<this._views.length;e+=1)this._views[e].listWillRemove(t)},t.prototype.listDidRemove=function(t,e){for(var i=0;i<this._views.length;i+=1)this._views[i].listDidRemove(t,e)},t.prototype.listWillDrop=function(t){for(var e=0;e<this._views.length;e+=1)this._views[e].listWillDrop(t)},t.prototype.listDidDrop=function(t){for(var e=0;e<this._views.length;e+=1)this._views[e].listDidDrop(t)},t.prototype.listWillTake=function(t){for(var e=0;e<this._views.length;e+=1)this._views[e].listWillTake(t)},t.prototype.listDidTake=function(t){for(var e=0;e<this._views.length;e+=1)this._views[e].listDidTake(t)},t.prototype.listWillClear=function(){for(var t=0;t<this._views.length;t+=1)this._views[t].listWillClear()},t.prototype.listDidClear=function(){for(var t=0;t<this._views.length;t+=1)this._views[t].listDidClear()},t}(b),C=function(f){function p(t,e,i,o,n,r,s,l,h,a,d,u,p){void 0===a&&(a=3),void 0===d&&(d={});var c=f.call(this,t,e,i,o,n,r,s,l,h,a,d)||this;return i&&(d.willInsert=i.willInsert||d.willInsert,d.didInsert=i.didInsert||d.didInsert,d.willUpdate=i.willUpdate||d.willUpdate,d.didUpdate=i.didUpdate||d.didUpdate,d.willMove=i.willMove||d.willMove,d.didMove=i.didMove||d.didMove,d.willRemove=i.willRemove||d.willRemove,d.didRemove=i.didRemove||d.didRemove,d.willDrop=i.willDrop||d.willDrop,d.didDrop=i.didDrop||d.didDrop,d.willTake=i.willTake||d.willTake,d.didTake=i.didTake||d.didTake,d.willClear=i.willClear||d.willClear,d.didClear=i.didClear||d.didClear,u=i.valueForm?i.valueForm:u),c._valueForm=u||y.Form.Value,c._state0=p,c}return h(p,f),p.prototype.copy=function(t,e,i,o,n,r,s,l,h,a,d,u){return 10===arguments.length&&(d=this._valueForm,u=this._state0),new p(t,e,void 0,i,o,n,r,s,l,h,a,d,u)},p.prototype.type=function(){return"list"},p.prototype.valueForm=function(t){return void 0===t?this._valueForm:this.copy(this._context,this._owner,this._hostUri,this._nodeUri,this._laneUri,this._prio,this._rate,this._body,this._flags,this.delegate,t,this._state0)},p.prototype.isEmpty=function(){return this._model.isEmpty()},Object.defineProperty(p.prototype,"length",{get:function(){return this._model.length},enumerable:!0,configurable:!0}),p.prototype.get=function(t,e){return this._model.get(t,e).coerce(this._valueForm)},p.prototype.getEntry=function(t,e){var i=this._model.getEntry(t,e);if(i)return[i[0].coerce(this._valueForm),i[1]]},p.prototype.set=function(t,e,i){var o=this._valueForm.mold(e);return this._model.set(t,o,i),this},p.prototype.insert=function(t,e,i){var o=this._valueForm.mold(e);return this._model.insert(t,o,i),this},p.prototype.remove=function(t,e){return this._model.remove(t,e),this},p.prototype.push=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];for(var i=new Array(t.length),o=0;o<t.length;o+=1)i[o]=this._valueForm.mold(t[o]);return this._model.push.apply(this._model,i)},p.prototype.pop=function(){return this._model.pop().coerce(this._valueForm)},p.prototype.unshift=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];for(var i=new Array(t.length),o=0;o<t.length;o+=1)i[o]=this._valueForm.mold(t[o]);return this._model.unshift.apply(this._model,i)},p.prototype.shift=function(){return this._model.shift().coerce(this._valueForm)},p.prototype.move=function(t,e,i){return this._model.move(t,e,i),this},p.prototype.splice=function(t,e){for(var i=[],o=2;o<arguments.length;o++)i[o-2]=arguments[o];for(var n=new Array(i.length),r=0;r<i.length;r+=1)n[r]=this._valueForm.mold(i[r]);var s,l=(s=this._model).splice.apply(s,[t,e].concat(n)),h=new Array(l.length);for(r=0;r<l.length;r+=1)h[r]=l[r].coerce(this._valueForm);return h},p.prototype.clear=function(){this._model.clear()},p.prototype.forEach=function(r,s){return this._valueForm===y.Form.Value?this._model._state.forEach(r,s):this._model._state.forEach(function(t,e,i,o){var n=t.coerce(this._valueForm);return r.call(s,n,e,this,o)},this)},p.prototype.values=function(){var t=this._model.values();return this._valueForm===y.Form.Value?t:new y.FormCursor(t,this._valueForm)},p.prototype.keys=function(){return this._model.keys()},p.prototype.entries=function(){var t=this._model.entries();return this._valueForm===y.Form.Value?t:new y.FormPairCursor(t,y.Form.Value,this._valueForm)},p.prototype.snapshot=function(){return this._model.snapshot()},p.prototype.setState=function(t){this._model.setState(t)},p.prototype.willInsert=function(t){return void 0===t?this.delegate.willInsert||null:(this.delegate.willInsert=t||void 0,this)},p.prototype.didInsert=function(t){return void 0===t?this.delegate.didInsert||null:(this.delegate.didInsert=t||void 0,this)},p.prototype.willUpdate=function(t){return void 0===t?this.delegate.willUpdate||null:(this.delegate.willUpdate=t||void 0,this)},p.prototype.didUpdate=function(t){return void 0===t?this.delegate.didUpdate||null:(this.delegate.didUpdate=t||void 0,this)},p.prototype.willMove=function(t){return void 0===t?this.delegate.willMove||null:(this.delegate.willMove=t||void 0,this)},p.prototype.didMove=function(t){return void 0===t?this.delegate.didMove||null:(this.delegate.didMove=t||void 0,this)},p.prototype.willRemove=function(t){return void 0===t?this.delegate.willRemove||null:(this.delegate.willRemove=t||void 0,this)},p.prototype.didRemove=function(t){return void 0===t?this.delegate.didRemove||null:(this.delegate.didRemove=t||void 0,this)},p.prototype.willDrop=function(t){return void 0===t?this.delegate.willDrop||null:(this.delegate.willDrop=t||void 0,this)},p.prototype.didDrop=function(t){return void 0===t?this.delegate.didDrop||null:(this.delegate.didDrop=t||void 0,this)},p.prototype.willTake=function(t){return void 0===t?this.delegate.willTake||null:(this.delegate.willTake=t||void 0,this)},p.prototype.didTake=function(t){return void 0===t?this.delegate.didTake||null:(this.delegate.didTake=t||void 0,this)},p.prototype.willClear=function(t){return void 0===t?this.delegate.willClear||null:(this.delegate.willClear=t||void 0,this)},p.prototype.didClear=function(t){return void 0===t?this.delegate.didClear||null:(this.delegate.didClear=t||void 0,this)},p.prototype.listWillInsert=function(t,e){if(this.delegate.willInsert){var i=e.coerce(this._valueForm);void 0!==(i=this.delegate.willInsert(t,i,this))&&(e=this._valueForm.mold(i))}return e},p.prototype.listDidInsert=function(t,e){if(this.delegate.didInsert){var i=e.coerce(this._valueForm);this.delegate.didInsert(t,i,this)}},p.prototype.listWillUpdate=function(t,e){if(this.delegate.willUpdate){var i=e.coerce(this._valueForm);void 0!==(i=this.delegate.willUpdate(t,i,this))&&(e=this._valueForm.mold(i))}return e},p.prototype.listDidUpdate=function(t,e,i){if(this.delegate.didUpdate){var o=e.coerce(this._valueForm),n=i.coerce(this._valueForm);this.delegate.didUpdate(t,o,n,this)}},p.prototype.listWillMove=function(t,e,i){if(this.delegate.willMove){var o=i.coerce(this._valueForm);this.delegate.willMove(t,e,o,this)}},p.prototype.listDidMove=function(t,e,i){if(this.delegate.didMove){var o=i.coerce(this._valueForm);this.delegate.didMove(t,e,o,this)}},p.prototype.listWillRemove=function(t){this.delegate.willRemove&&this.delegate.willRemove(t,this)},p.prototype.listDidRemove=function(t,e){if(this.delegate.didRemove){var i=e.coerce(this._valueForm);this.delegate.didRemove(t,i,this)}},p.prototype.listWillDrop=function(t){this.delegate.willDrop&&this.delegate.willDrop(t,this)},p.prototype.listDidDrop=function(t){this.delegate.didDrop&&this.delegate.didDrop(t,this)},p.prototype.listWillTake=function(t){this.delegate.willTake&&this.delegate.willTake(t,this)},p.prototype.listDidTake=function(t){this.delegate.didTake&&this.delegate.didTake(t,this)},p.prototype.listWillClear=function(){this.delegate.willClear&&this.delegate.willClear(this)},p.prototype.listDidClear=function(){this.delegate.didClear&&this.delegate.didClear(this)},p.prototype.initialState=function(t){return void 0===t?this._state0||null:this.copy(this._context,this._owner,this._hostUri,this._nodeUri,this._laneUri,this._prio,this._rate,this._body,this._flags,this.delegate,this._valueForm,t||void 0)},p.prototype.didAliasModel=function(){this.onLinkedResponse(),this._model._state.forEach(function(t,e){this.listDidInsert(e,t)},this),this.onSyncedResponse()},p.prototype.open=function(){var t=this._laneUri;if(t.isEmpty())throw new Error("no lane");var e=this._nodeUri;if(e.isEmpty())throw new Error("no node");var i=this._hostUri;i.isEmpty()&&(i=e.base(),e=y.Uri.unresolve(i,e));var o=this._context.getDownlink(i,e,t);if(o){if(!(o instanceof V))throw new Error("downlink type mismatch");o.addDownlink(this),this._model=o,this.didAliasModel()}else(o=new V(this._context,i,e,t,this._prio,this._rate,this._body,this._state0)).addDownlink(this),this._context.openDownlink(o),this._model=o;return this._owner&&this._owner.addDownlink(this),this},p}(D),F=function(i){function t(t){var e=i.call(this)||this;return e._downlink=t,e}return h(t,i),Object.defineProperty(t.prototype,"downlink",{get:function(){return this._downlink},enumerable:!0,configurable:!0}),t.prototype.isEmpty=function(){return this._downlink.isEmpty()},t.prototype.isArray=function(){return!0},t.prototype.isObject=function(){return this._downlink.isEmpty()},Object.defineProperty(t.prototype,"length",{get:function(){return this._downlink.length},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"size",{get:function(){return this._downlink.length},enumerable:!0,configurable:!0}),t.prototype.has=function(t){return!1},t.prototype.get=function(t){return y.Value.Absent},t.prototype.getAttr=function(t){return y.Value.Absent},t.prototype.getItem=function(t){t instanceof y.Num&&(t=t.value);var e=this._downlink.length;return t<0&&(t=e+t),0<=(t=Math.min(Math.max(0,t),e-1))?this._downlink.get(t):y.Item.Absent},t.prototype.set=function(t,e){throw new Error("unsupported")},t.prototype.setAttr=function(t,e){throw new Error("unsupported")},t.prototype.setItem=function(t,e){t instanceof y.Num&&(t=t.value);var i=this._downlink.length;return t<0&&(t=i+t),0<=(t=Math.min(Math.max(0,t),i-1))&&this._downlink.set(t,y.Value.fromAny(e)),this},t.prototype.push=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];return this._downlink.push.apply(this._downlink,arguments)},t.prototype.splice=function(t,e){for(var i=[],o=2;o<arguments.length;o++)i[o-2]=arguments[o];return this._downlink.splice.apply(this._downlink,arguments)},t.prototype.delete=function(t){return y.Item.Absent},t.prototype.clear=function(){this._downlink.clear()},t.prototype.forEach=function(i,o){return this._downlink.forEach(function(t,e){return i.call(o,t,e)})},t}(y.Record),S=function(a){function t(t,e,i,o,n,r,s,l){void 0===l&&(l=new y.BTree);var h=a.call(this,t,e,i,o,n,r,s)||this;return h._state=l,h}return h(t,a),t.prototype.type=function(){return"map"},Object.defineProperty(t.prototype,"size",{get:function(){return this._state.size},enumerable:!0,configurable:!0}),t.prototype.isEmpty=function(){return this._state.isEmpty()},t.prototype.has=function(t){return this._state.has(t)},t.prototype.get=function(t){return this._state.get(t)||y.Value.Absent},t.prototype.getEntry=function(t){return this._state.getEntry(t)},t.prototype.set=function(t,e){e=this.mapWillUpdate(t,e);var i=this._state.get(t)||y.Value.Absent;this._state.set(t,e),this.mapDidUpdate(t,e,i);var o=y.Record.empty(1).slot("key",t);return this.command(y.Attr.of("update",o).concat(e)),this},t.prototype.delete=function(t){if(this._state.has(t)){this.mapWillRemove(t);var e=this._state.get(t)||y.Value.Absent;this._state.delete(t),this.mapDidRemove(t,e);var i=y.Record.empty(1).slot("key",t);return this.command(y.Record.empty(1).attr("remove",i)),!0}return!1},t.prototype.drop=function(t){return this.mapWillDrop(t),this._state.drop(t),this.mapDidDrop(t),this.command(y.Record.empty(1).attr("drop",t)),this},t.prototype.take=function(t){return this.mapWillTake(t),this._state.take(t),this.mapDidTake(t),this.command(y.Record.empty(1).attr("take",t)),this},t.prototype.clear=function(){this.mapWillClear(),this._state.clear(),this.mapDidClear(),this.command(y.Record.empty(1).attr("clear"))},t.prototype.forEach=function(i,o){return this._state.forEach(function(t,e){return i.call(o,t,e,this)},this)},t.prototype.keys=function(){return this._state.keys()},t.prototype.values=function(){return this._state.values()},t.prototype.entries=function(){return this._state.entries()},t.prototype.snapshot=function(){return this._state.clone()},t.prototype.setState=function(t){this._state=t},t.prototype.onEventMessage=function(t,e){a.prototype.onEventMessage.call(this,t,e);var i=t.body(),o=i.tag;if("update"===o){var n=i.head().toValue();this.onUpdateEvent(n.get("key"),i.body())}else if("remove"===o){n=i.head().toValue();this.onRemoveEvent(n.get("key"))}else if("drop"===o){n=i.head().toValue();this.onDropEvent(n.numberValue(0))}else if("take"===o){n=i.head().toValue();this.onTakeEvent(n.numberValue(0))}else"clear"===o&&this.onClearEvent()},t.prototype.onUpdateEvent=function(t,e){e=this.mapWillUpdate(t,e);var i=this._state.get(t)||y.Value.Absent;this._state.set(t,e),this.mapDidUpdate(t,e,i)},t.prototype.onRemoveEvent=function(t){this.mapWillRemove(t);var e=this._state.get(t)||y.Value.Absent;this._state.delete(t),this.mapDidRemove(t,e)},t.prototype.onDropEvent=function(t){this.mapWillDrop(t),this._state.drop(t),this.mapDidDrop(t)},t.prototype.onTakeEvent=function(t){this.mapWillTake(t),this._state.take(t),this.mapDidTake(t)},t.prototype.onClearEvent=function(){this.mapWillClear(),this._state.clear(),this.mapDidClear()},t.prototype.mapWillUpdate=function(t,e){for(var i=0;i<this._views.length;i+=1)e=this._views[i].mapWillUpdate(t,e);return e},t.prototype.mapDidUpdate=function(t,e,i){for(var o=0;o<this._views.length;o+=1)this._views[o].mapDidUpdate(t,e,i)},t.prototype.mapWillRemove=function(t){for(var e=0;e<this._views.length;e+=1)this._views[e].mapWillRemove(t)},t.prototype.mapDidRemove=function(t,e){for(var i=0;i<this._views.length;i+=1)this._views[i].mapDidRemove(t,e)},t.prototype.mapWillDrop=function(t){for(var e=0;e<this._views.length;e+=1)this._views[e].mapWillDrop(t)},t.prototype.mapDidDrop=function(t){for(var e=0;e<this._views.length;e+=1)this._views[e].mapDidDrop(t)},t.prototype.mapWillTake=function(t){for(var e=0;e<this._views.length;e+=1)this._views[e].mapWillTake(t)},t.prototype.mapDidTake=function(t){for(var e=0;e<this._views.length;e+=1)this._views[e].mapDidTake(t)},t.prototype.mapWillClear=function(){for(var t=0;t<this._views.length;t+=1)this._views[t].mapWillClear()},t.prototype.mapDidClear=function(){for(var t=0;t<this._views.length;t+=1)this._views[t].mapDidClear()},t}(b),x=function(_){function c(t,e,i,o,n,r,s,l,h,a,d,u,p,c){void 0===a&&(a=3),void 0===d&&(d={});var f=_.call(this,t,e,i,o,n,r,s,l,h,a,d)||this;return i&&(d.willUpdate=i.willUpdate||d.willUpdate,d.didUpdate=i.didUpdate||d.didUpdate,d.willRemove=i.willRemove||d.willRemove,d.didRemove=i.didRemove||d.didRemove,d.willDrop=i.willDrop||d.willDrop,d.didDrop=i.didDrop||d.didDrop,d.willTake=i.willTake||d.willTake,d.didTake=i.didTake||d.didTake,d.willClear=i.willClear||d.willClear,d.didClear=i.didClear||d.didClear,u=i.keyForm?i.keyForm:u,p=i.valueForm?i.valueForm:p),f._keyForm=u||y.Form.Value,f._valueForm=p||y.Form.Value,f._state0=c,f}return h(c,_),c.prototype.copy=function(t,e,i,o,n,r,s,l,h,a,d,u,p){return 10===arguments.length&&(p=this._state0,d=this._keyForm,u=this._valueForm),new c(t,e,void 0,i,o,n,r,s,l,h,a,d,u,p)},c.prototype.type=function(){return"map"},c.prototype.keyForm=function(t){return void 0===t?this._keyForm:this.copy(this._context,this._owner,this._hostUri,this._nodeUri,this._laneUri,this._prio,this._rate,this._body,this._flags,this.delegate,t,this._valueForm,this._state0)},c.prototype.valueForm=function(t){return void 0===t?this._valueForm:this.copy(this._context,this._owner,this._hostUri,this._nodeUri,this._laneUri,this._prio,this._rate,this._body,this._flags,this.delegate,this._keyForm,t,this._state0)},Object.defineProperty(c.prototype,"size",{get:function(){return this._model.size},enumerable:!0,configurable:!0}),c.prototype.isEmpty=function(){return this._model.isEmpty()},c.prototype.has=function(t){var e=this._keyForm.mold(t);return this._model.has(e)},c.prototype.get=function(t){var e=this._keyForm.mold(t);return this._model.get(e).coerce(this._valueForm)},c.prototype.getEntry=function(t){var e=this._model.getEntry(t);if(e)return[e[0].coerce(this._keyForm),e[1].coerce(this._valueForm)]},c.prototype.set=function(t,e){var i=this._keyForm.mold(t),o=this._valueForm.mold(e);return this._model.set(i,o),this},c.prototype.delete=function(t){var e=this._keyForm.mold(t);return this._model.delete(e)},c.prototype.drop=function(t){return this._model.drop(t),this},c.prototype.take=function(t){return this._model.take(t),this},c.prototype.clear=function(){this._model.clear()},c.prototype.forEach=function(n,r){return this._keyForm===y.Form.Value&&this._valueForm===y.Form.Value?this._model._state.forEach(n,r):this._model._state.forEach(function(t,e){var i=t.coerce(this._keyForm),o=e.coerce(this._valueForm);return n.call(r,i,o,this)},this)},c.prototype.keys=function(){var t=this._model.keys();return this._keyForm===y.Form.Value?t:new y.FormCursor(t,this._keyForm)},c.prototype.values=function(){var t=this._model.values();return this._valueForm===y.Form.Value?t:new y.FormCursor(t,this._valueForm)},c.prototype.entries=function(){var t=this._model.entries();return this._keyForm===y.Form.Value&&this._valueForm===y.Form.Value?t:new y.FormPairCursor(t,this._keyForm,this._valueForm)},c.prototype.snapshot=function(){return this._model.snapshot()},c.prototype.setState=function(t){this._model.setState(t)},c.prototype.willUpdate=function(t){return void 0===t?this.delegate.willUpdate||null:(this.delegate.willUpdate=t||void 0,this)},c.prototype.didUpdate=function(t){return void 0===t?this.delegate.didUpdate||null:(this.delegate.didUpdate=t||void 0,this)},c.prototype.willRemove=function(t){return void 0===t?this.delegate.willRemove||null:(this.delegate.willRemove=t||void 0,this)},c.prototype.didRemove=function(t){return void 0===t?this.delegate.didRemove||null:(this.delegate.didRemove=t||void 0,this)},c.prototype.willDrop=function(t){return void 0===t?this.delegate.willDrop||null:(this.delegate.willDrop=t||void 0,this)},c.prototype.didDrop=function(t){return void 0===t?this.delegate.didDrop||null:(this.delegate.didDrop=t||void 0,this)},c.prototype.willTake=function(t){return void 0===t?this.delegate.willTake||null:(this.delegate.willTake=t||void 0,this)},c.prototype.didTake=function(t){return void 0===t?this.delegate.didTake||null:(this.delegate.didTake=t||void 0,this)},c.prototype.willClear=function(t){return void 0===t?this.delegate.willClear||null:(this.delegate.willClear=t||void 0,this)},c.prototype.didClear=function(t){return void 0===t?this.delegate.didClear||null:(this.delegate.didClear=t||void 0,this)},c.prototype.mapWillUpdate=function(t,e){if(this.delegate.willUpdate){var i=t.coerce(this._keyForm),o=e.coerce(this._valueForm);void 0!==(o=this.delegate.willUpdate(i,o,this))&&(e=this._valueForm.mold(o))}return e},c.prototype.mapDidUpdate=function(t,e,i){if(this.delegate.didUpdate){var o=t.coerce(this._keyForm),n=e.coerce(this._valueForm),r=i.coerce(this._valueForm);this.delegate.didUpdate(o,n,r,this)}},c.prototype.mapWillRemove=function(t){if(this.delegate.willRemove){var e=t.coerce(this._keyForm);this.delegate.willRemove(e,this)}},c.prototype.mapDidRemove=function(t,e){if(this.delegate.didRemove){var i=t.coerce(this._keyForm),o=e.coerce(this._valueForm);this.delegate.didRemove(i,o,this)}},c.prototype.mapWillDrop=function(t){this.delegate.willDrop&&this.delegate.willDrop(t,this)},c.prototype.mapDidDrop=function(t){this.delegate.didDrop&&this.delegate.didDrop(t,this)},c.prototype.mapWillTake=function(t){this.delegate.willTake&&this.delegate.willTake(t,this)},c.prototype.mapDidTake=function(t){this.delegate.didTake&&this.delegate.didTake(t,this)},c.prototype.mapWillClear=function(){this.delegate.willClear&&this.delegate.willClear(this)},c.prototype.mapDidClear=function(){this.delegate.didClear&&this.delegate.didClear(this)},c.prototype.initialState=function(t){return void 0===t?this._state0||null:this.copy(this._context,this._owner,this._hostUri,this._nodeUri,this._laneUri,this._prio,this._rate,this._body,this._flags,this.delegate,this._keyForm,this._valueForm,t||void 0)},c.prototype.didAliasModel=function(){this.onLinkedResponse(),this._model._state.forEach(function(t,e){this.mapDidUpdate(e,t,void 0)},this),this.onSyncedResponse()},c.prototype.open=function(){var t=this._laneUri;if(t.isEmpty())throw new Error("no lane");var e=this._nodeUri;if(e.isEmpty())throw new Error("no node");var i=this._hostUri;i.isEmpty()&&(i=e.base(),e=y.Uri.unresolve(i,e));var o=this._context.getDownlink(i,e,t);if(o){if(!(o instanceof S))throw new Error("downlink type mismatch");o.addDownlink(this),this._model=o,this.didAliasModel()}else(o=new S(this._context,i,e,t,this._prio,this._rate,this._body,this._state0)).addDownlink(this),this._context.openDownlink(o),this._model=o;return this._owner&&this._owner.addDownlink(this),this},c}(D),T=function(i){function t(t){var e=i.call(this)||this;return e._downlink=t,e}return h(t,i),Object.defineProperty(t.prototype,"downlink",{get:function(){return this._downlink},enumerable:!0,configurable:!0}),t.prototype.isEmpty=function(){return this._downlink.isEmpty()},t.prototype.isArray=function(){return this._downlink.isEmpty()},t.prototype.isObject=function(){return!0},Object.defineProperty(t.prototype,"length",{get:function(){return this._downlink.size},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"size",{get:function(){return this._downlink.size},enumerable:!0,configurable:!0}),t.prototype.has=function(t){return this._downlink.has(t)},t.prototype.get=function(t){return this._downlink.get(t)},t.prototype.getAttr=function(t){return y.Value.Absent},t.prototype.getItem=function(t){t instanceof y.Num&&(t=t.value);var e=this._downlink.size;if(t<0&&(t=e+t),0<=(t=Math.min(Math.max(0,t),e-1))){var i=this._downlink.getEntry(t);return y.Slot.of(i[0],i[1])}return y.Item.Absent},t.prototype.set=function(t,e){return this._downlink.set(t,e),this},t.prototype.setAttr=function(t,e){throw new Error("unsupported")},t.prototype.setItem=function(t,e){throw new Error("unsupported")},t.prototype.push=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];throw new Error("unsupported")},t.prototype.splice=function(t,e){for(var i=[],o=2;o<arguments.length;o++)i[o-2]=arguments[o];throw new Error("unsupported")},t.prototype.delete=function(t){t=y.Value.fromAny(t);var e=this._downlink.get(t);return this._downlink.delete(t)?y.Slot.of(t,e):y.Item.Absent},t.prototype.clear=function(){this._downlink.clear()},t.prototype.forEach=function(o,n){var r=0;return this._downlink.forEach(function(t,e){var i=o.call(n,y.Slot.of(t,e),r);return r+=1,i})},t}(y.Record),W=function(a){function t(t,e,i,o,n,r,s,l){void 0===l&&(l=y.Value.Absent);var h=a.call(this,t,e,i,o,n,r,s)||this;return h._state=l,h}return h(t,a),t.prototype.type=function(){return"value"},t.prototype.get=function(){return this._state},t.prototype.set=function(t){t=this.valueWillSet(t);var e=this._state;this.setState(t),this.valueDidSet(t,e),this.command(t)},t.prototype.setState=function(t){this._state=t},t.prototype.onEventMessage=function(t,e){a.prototype.onEventMessage.call(this,t,e),this.onSetEvent(t.body())},t.prototype.onSetEvent=function(t){t=this.valueWillSet(t);var e=this._state;this.setState(t),this.valueDidSet(t,e)},t.prototype.valueWillSet=function(t){for(var e=0;e<this._views.length;e+=1)t=this._views[e].valueWillSet(t);return t},t.prototype.valueDidSet=function(t,e){for(var i=0;i<this._views.length;i+=1)this._views[i].valueDidSet(t,e)},t}(b),O=function(f){function p(t,e,i,o,n,r,s,l,h,a,d,u,p){void 0===a&&(a=3),void 0===d&&(d={}),void 0===p&&(p=y.Value.Absent);var c=f.call(this,t,e,i,o,n,r,s,l,h,a,d)||this;return i&&(d.willSet=i.willSet||d.willSet,d.didSet=i.didSet||d.didSet,u=i.valueForm?i.valueForm:u),c._valueForm=u||y.Form.Value,c._state0=p,c}return h(p,f),p.prototype.copy=function(t,e,i,o,n,r,s,l,h,a,d,u){return 10===arguments.length&&(u=this._state0,d=this._valueForm),new p(t,e,void 0,i,o,n,r,s,l,h,a,d,u)},p.prototype.type=function(){return"value"},p.prototype.valueForm=function(t){return void 0===t?this._valueForm:this.copy(this._context,this._owner,this._hostUri,this._nodeUri,this._laneUri,this._prio,this._rate,this._body,this._flags,this.delegate,t,this._state0)},p.prototype.get=function(){return this._model.get()},p.prototype.set=function(t){var e=this._valueForm.mold(t);this._model.set(e)},p.prototype.setState=function(t){this._model.setState(t)},p.prototype.willSet=function(t){return void 0===t?this.delegate.willSet||null:(this.delegate.willSet=t||void 0,this)},p.prototype.didSet=function(t){return void 0===t?this.delegate.didSet||null:(this.delegate.didSet=t||void 0,this)},p.prototype.valueWillSet=function(t){if(this.delegate.willSet){var e=t.coerce(this._valueForm);void 0!==(e=this.delegate.willSet(e,this))&&(t=this._valueForm.mold(e))}return t},p.prototype.valueDidSet=function(t,e){if(this.delegate.didSet){var i=t.coerce(this._valueForm),o=e.coerce(this._valueForm);this.delegate.didSet(i,o,this)}},p.prototype.initialState=function(t){return void 0===t?this._state0:this.copy(this._context,this._owner,this._hostUri,this._nodeUri,this._laneUri,this._prio,this._rate,this._body,this._flags,this.delegate,this._valueForm,t)},p.prototype.didAliasModel=function(){this.onLinkedResponse(),this.valueDidSet(this.get(),y.Value.Absent),this.onSyncedResponse()},p.prototype.open=function(){var t=this._laneUri;if(t.isEmpty())throw new Error("no lane");var e=this._nodeUri;if(e.isEmpty())throw new Error("no node");var i=this._hostUri;i.isEmpty()&&(i=e.base(),e=y.Uri.unresolve(i,e));var o=this._context.getDownlink(i,e,t);if(o){if(!(o instanceof W))throw new Error("downlink type mismatch");o.addDownlink(this),this._model=o,this.didAliasModel()}else(o=new W(this._context,i,e,t,this._prio,this._rate,this._body,this._state0)).addDownlink(this),this._context.openDownlink(o),this._model=o;return this._owner&&this._owner.addDownlink(this),this},p}(D),M=function(i){function t(t){var e=i.call(this)||this;return e._downlink=t,e}return h(t,i),Object.defineProperty(t.prototype,"downlink",{get:function(){return this._downlink},enumerable:!0,configurable:!0}),t.prototype.isEmpty=function(){var t=this._downlink.get();return t instanceof y.Record?t.isEmpty():!t.isDefined()},t.prototype.isArray=function(){var t=this._downlink.get();return t instanceof y.Record?t.isArray():!t.isDefined()||t instanceof y.Value},t.prototype.isObject=function(){var t=this._downlink.get();return t instanceof y.Record?t.isObject():!t.isDefined()||t instanceof y.Field},Object.defineProperty(t.prototype,"length",{get:function(){var t=this._downlink.get();return t instanceof y.Record?t.length:t.isDefined()?1:0},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"size",{get:function(){var t=this._downlink.get();return t instanceof y.Record?t.size:t.isDefined()?1:0},enumerable:!0,configurable:!0}),t.prototype.has=function(t){var e=this._downlink.get();return e instanceof y.Record&&e.has(t)},t.prototype.get=function(t){var e=this._downlink.get();return e instanceof y.Record?e.get(t):y.Value.Absent},t.prototype.getAttr=function(t){var e=this._downlink.get();return e instanceof y.Record?e.getAttr(t):y.Value.Absent},t.prototype.getItem=function(t){var e=this._downlink.get();return e instanceof y.Record?e.getItem(t):e},t.prototype.set=function(t,e){var i=this._downlink.get();if(!(i instanceof y.Record))throw new Error("unsupported");return i.set(t,e),this},t.prototype.setAttr=function(t,e){var i=this._downlink.get();if(!(i instanceof y.Record))throw new Error("unsupported");return i.setAttr(t,e),this},t.prototype.setItem=function(t,e){var i=this._downlink.get();return i instanceof y.Record?i.setItem(t,e):this._downlink.set(y.Value.fromAny(e)),this},t.prototype.push=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];var i=this._downlink.get();if(i instanceof y.Record)return i.push.apply(i,arguments);throw new Error("unsupported")},t.prototype.splice=function(t,e){for(var i=[],o=2;o<arguments.length;o++)i[o-2]=arguments[o];var n=this._downlink.get();if(n instanceof y.Record)return n.splice.apply(n,arguments);throw new Error("unsupported")},t.prototype.delete=function(t){var e=this._downlink.get();return e instanceof y.Record?e.delete(t):y.Value.Absent},t.prototype.clear=function(){var t=this._downlink.get();if(!(t instanceof y.Record))throw new Error("unsupported");t.clear()},t.prototype.forEach=function(t,e){return this._downlink.get().forEach(t,e)},t}(y.Record),I=function(){function t(t){this._context=t,this._remote=void 0,this._downlinks=[],this.delegate={}}return t.prototype.isConnected=function(){return!!this._remote&&this._remote.isConnected()},t.prototype.isAuthenticated=function(){return!!this._remote&&this._remote.isAuthenticated()},Object.defineProperty(t.prototype,"session",{get:function(){return this._remote?this._remote.session:y.Value.Absent},enumerable:!0,configurable:!0}),t.prototype.authenticate=function(t){this._context.authenticate(this.hostUri(),t)},t.prototype.addDownlink=function(t){0===this._downlinks.length&&this.open(),this._downlinks.push(t)},t.prototype.removeDownlink=function(t){var e=this._downlinks.indexOf(t);0<=e&&(this._downlinks.splice(e,1),0===this._downlinks.length&&this.close())},t.prototype.open=function(){this._context.openRef(this)},t.prototype.close=function(){this._context.closeRef(this)},t.prototype.closeUp=function(){var t=this._downlinks;this._downlinks=[];for(var e=0,i=t.length;e<i;e+=1)t[e].close()},t.prototype.didConnect=function(t){return void 0===t?this.delegate.didConnect||null:(this.delegate.didConnect=t||void 0,this)},t.prototype.didAuthenticate=function(t){return void 0===t?this.delegate.didAuthenticate||null:(this.delegate.didAuthenticate=t||void 0,this)},t.prototype.didDeauthenticate=function(t){return void 0===t?this.delegate.didDeauthenticate||null:(this.delegate.didDeauthenticate=t||void 0,this)},t.prototype.didDisconnect=function(t){return void 0===t?this.delegate.didDisconnect||null:(this.delegate.didDisconnect=t||void 0,this)},t.prototype.didFail=function(t){return void 0===t?this.delegate.didFail||null:(this.delegate.didFail=t||void 0,this)},t.prototype.hostDidConnect=function(t){this._remote=t,this.delegate.didConnect&&this.delegate.didConnect(t,this)},t.prototype.hostDidAuthenticate=function(t,e){this.delegate.didAuthenticate&&this.delegate.didAuthenticate(t,e,this)},t.prototype.hostDidDeauthenticate=function(t,e){this.delegate.didDeauthenticate&&this.delegate.didDeauthenticate(t,e,this)},t.prototype.hostDidDisconnect=function(t){this._remote=void 0,this.delegate.didDisconnect&&this.delegate.didDisconnect(t,this)},t.prototype.hostDidFail=function(t,e){this.delegate.didFail&&this.delegate.didFail(t,e,this)},t}(),L=function(o){function t(t,e){var i=o.call(this,t)||this;return i._hostUri=e,i}return h(t,o),t.prototype.hostUri=function(){return this._hostUri},t.prototype.nodeRef=function(t){return t=y.Uri.fromAny(t),new j(this._context,this._hostUri,t)},t.prototype.laneRef=function(t,e){return t=y.Uri.fromAny(t),e=y.Uri.fromAny(e),new P(this._context,this._hostUri,t,e)},t.prototype.downlink=function(t){return new A(this._context,this,t,this._hostUri)},t.prototype.downlinkList=function(t){return new C(this._context,this,t,this._hostUri)},t.prototype.downlinkMap=function(t){return new x(this._context,this,t,this._hostUri)},t.prototype.downlinkValue=function(t){return new O(this._context,this,t,this._hostUri)},t.prototype.command=function(t,e,i){this._context.command(this._hostUri,t,e,i)},t}(I),j=function(n){function t(t,e,i){var o=n.call(this,t)||this;return o._hostUri=e,o._nodeUri=i,o}return h(t,n),t.prototype.hostUri=function(){return this._hostUri},t.prototype.nodeUri=function(){return this._nodeUri},t.prototype.laneRef=function(t){return t=y.Uri.fromAny(t),new P(this._context,this._hostUri,this._nodeUri,t)},t.prototype.downlink=function(t){return new A(this._context,this,t,this._hostUri,this._nodeUri)},t.prototype.downlinkList=function(t){return new C(this._context,this,t,this._hostUri,this._nodeUri)},t.prototype.downlinkMap=function(t){return new x(this._context,this,t,this._hostUri,this._nodeUri)},t.prototype.downlinkValue=function(t){return new O(this._context,this,t,this._hostUri,this._nodeUri)},t.prototype.command=function(t,e){this._context.command(this._hostUri,this._nodeUri,t,e)},t}(I),P=function(r){function t(t,e,i,o){var n=r.call(this,t)||this;return n._hostUri=e,n._nodeUri=i,n._laneUri=o,n}return h(t,r),t.prototype.hostUri=function(){return this._hostUri},t.prototype.nodeUri=function(){return this._nodeUri},t.prototype.laneUri=function(){return this._laneUri},t.prototype.downlink=function(t){return new A(this._context,this,t,this._hostUri,this._nodeUri,this._laneUri)},t.prototype.downlinkList=function(t){return new C(this._context,this,t,this._hostUri,this._nodeUri,this._laneUri)},t.prototype.downlinkMap=function(t){return new x(this._context,this,t,this._hostUri,this._nodeUri,this._laneUri)},t.prototype.downlinkValue=function(t){return new O(this._context,this,t,this._hostUri,this._nodeUri,this._laneUri)},t.prototype.command=function(t){this._context.command(this._hostUri,this._nodeUri,this._laneUri,t)},t}(I),q=function(i){function t(t){var e=i.call(this,t)||this;return e._downlinks=[],e}return h(t,i),t.prototype.addDownlink=function(t){this._downlinks.push(t)},t.prototype.removeDownlink=function(t){var e=this._downlinks.indexOf(t);0<=e&&this._downlinks.splice(e,1)},t.prototype.initDownlink=function(t,e){return t},t.prototype.downlink=function(t,e){return void 0===e&&(e=this.stack()),new A(this.downlinkContext,this,this.initDownlink(t,e))},t.prototype.downlinkList=function(t,e){return void 0===e&&(e=this.stack()),new C(this.downlinkContext,this,this.initDownlink(t,e))},t.prototype.downlinkMap=function(t,e){return void 0===e&&(e=this.stack()),new x(this.downlinkContext,this,this.initDownlink(t,e))},t.prototype.downlinkValue=function(t,e){return void 0===e&&(e=this.stack()),new O(this.downlinkContext,this,this.initDownlink(t,e))},t.prototype.importDownlink=function(t,e){var i,o;if(z(t)){var n=t,r=n.downlink;if(i=t.declaration,!(o=this.initDownlink(D.InitForm.cast(i.evaluate(e).toValue()),e)))return r.close(),n.declaration;if(r.hostUri().equals(o.hostUri)&&r.nodeUri().equals(o.nodeUri)&&r.laneUri().equals(o.laneUri))return n;r.close()}else i=t,o=D.InitForm.cast(i.evaluate(e).toValue());if(o)try{if("list"===o.type)return new B(this,this.downlinkList(o).open(),i);if("map"===o.type)return new H(this,this.downlinkMap(o).open(),i);if("value"===o.type)return new K(this,this.downlinkValue(o).open(),i)}catch(t){}return t},t.prototype.materializeValue=function(t,e){if("link"===t.tag||z(t)){var i=this.importDownlink(t,e);if(z(i))return i}return t},t.prototype.materializeItem=function(t,e){if(t instanceof y.Field){if((i=t.value)!==(o=this.materializeValue(i,e)))return t.withValue(o)}else if(t instanceof y.Value){var i,o;if((i=t)!==(o=this.materializeValue(i,e)))return o}return t},t.prototype.materializeScope=function(t){void 0===t&&(t=this.stack());for(var e=this._record,i=e.length,o=0;o<i;){var n=e.getItem(o),r=this.materializeItem(n,t);r.isDefined()?(n!==r&&e.setItem(o,r),o+=1):e.splice(o,1)}},t.prototype.close=function(){var t=this._downlinks;this._downlinks=[];for(var e=0,i=t.length;e<i;e+=1)t[e].close()},t}(y.RecordScope);function z(t){return!!(t instanceof y.Record&&t.declaration)}var B=function(n){function t(t,e,i){var o=n.call(this,e)||this;return o._scope=t,o._declaration=i.commit(),o.downlink.delegate=o}return h(t,n),Object.defineProperty(t.prototype,"declaration",{get:function(){return this._declaration},enumerable:!0,configurable:!0}),t.prototype.didInsert=function(t,e){this._scope.didChange(e,y.Value.Absent,t)},t.prototype.didUpdate=function(t,e,i){this._scope.didChange(e,i,t)},t.prototype.didMove=function(t,e,i){this._scope.didChange(i,i,e)},t.prototype.didRemove=function(t,e){this._scope.didChange(y.Value.Absent,e,t)},t.prototype.didDrop=function(t){this._scope.didChange()},t.prototype.didTake=function(t){this._scope.didChange()},t.prototype.didClear=function(){this._scope.didChange()},t}(F),H=function(n){function t(t,e,i){var o=n.call(this,e)||this;return o._scope=t,o._declaration=i.commit(),o.downlink.delegate=o}return h(t,n),Object.defineProperty(t.prototype,"declaration",{get:function(){return this._declaration},enumerable:!0,configurable:!0}),t.prototype.didUpdate=function(t,e,i){this._scope.didChange(y.Slot.of(t,e),y.Slot.of(t,i))},t.prototype.didRemove=function(t,e){this._scope.didChange(y.Item.Absent,y.Slot.of(t,e))},t.prototype.didDrop=function(t){this._scope.didChange()},t.prototype.didTake=function(t){this._scope.didChange()},t.prototype.didClear=function(){this._scope.didChange()},t}(T),K=function(n){function t(t,e,i){var o=n.call(this,e)||this;return o._scope=t,o._declaration=i.commit(),o.downlink.delegate=o}return h(t,n),Object.defineProperty(t.prototype,"declaration",{get:function(){return this._declaration},enumerable:!0,configurable:!0}),t.prototype.didSet=function(t,e){this._scope.didChange(t,e)},t}(M),N=function(n){function t(t,e,i){void 0===i&&(i={});var o=n.call(this,t,e,i)||this;return o.onWebSocketOpen=o.onWebSocketOpen.bind(o),o.onWebSocketMessage=o.onWebSocketMessage.bind(o),o.onWebSocketClose=o.onWebSocketClose.bind(o),o.onWebSocketError=o.onWebSocketError.bind(o),o}return h(t,n),Object.defineProperty(t.prototype,"WebSocket",{get:function(){return this._options.WebSocket||"undefined"!=typeof WebSocket&&WebSocket||"function"==typeof require&&require("ws")||void 0},enumerable:!0,configurable:!0}),t.prototype.isConnected=function(){return!!this._socket&&this._socket.readyState===this._socket.OPEN},t.prototype.open=function(){if(this.clearReconnect(),!this._socket){var t=this.WebSocket;if(!t)throw new Error("undefined WebSocket");var e=this._hostUri;"swim"===e.scheme().name?e=e.scheme("ws"):"swims"===e.scheme().name&&(e=e.scheme("wss")),this._options.protocols?this._socket=new t(e.toUri(),this._options.protocols):this._socket=new t(e.toUri()),this._socket.onopen=this.onWebSocketOpen,this._socket.onmessage=this.onWebSocketMessage,this._socket.onclose=this.onWebSocketClose,this._socket.onerror=this.onWebSocketError}},t.prototype.close=function(){this.clearReconnect(),this.clearIdle(),this._socket?(this._socket.close(),this._context.isOnline()||this.onWebSocketClose()):n.prototype.close.call(this)},t.prototype.push=function(t){if(this.isConnected()){this.clearIdle();var e=t.toRecon();this._socket.send(e),this.watchIdle()}else if(t instanceof d){if(!(this._sendBuffer.length<this.sendBufferSize))throw new Error("send buffer overflow");this._sendBuffer.push(t),this.open()}},t.prototype.onWebSocketOpen=function(){if(this.isConnected()){var t=this.credentials;if(t.isDefined()){var e=new m(t);this.push(e)}this.onConnect();for(var i=void 0;(i=this._sendBuffer.shift())&&this.isConnected();)this.push(i);this.watchIdle()}else this.close()},t.prototype.onWebSocketMessage=function(t){var e=t.data;if("string"==typeof e){var i=r.parseRecon(e);i?this.onEnvelope(i):this.onUnknownEnvelope(e)}},t.prototype.onWebSocketClose=function(){this._socket&&(this._socket.onopen=void 0,this._socket.onmessage=void 0,this._socket.onclose=void 0,this._socket.onerror=void 0,this._socket=void 0),this.onDisconnect(),this.clearIdle(),this.isIdle()?this.close():this._context.isOnline()&&this.reconnect()},t.prototype.onWebSocketError=function(){this.onError(),this._socket&&this._socket.close()},t}(U),G=function(){function t(t){void 0===t&&(t={}),this._options=t,this._hosts=new y.BTree,this._downlinks=new y.BTree,this._downlinkCount=0,this._refs=[],this._online=!0,this.delegate={},this.onOnline=this.onOnline.bind(this),this.onOffline=this.onOffline.bind(this),this.watchOnline(!!t.keepOnline)}return t.prototype.isOnline=function(i){return void 0===i?this._online:(this._online!==i&&(this._online=i,this._hosts.forEach(function(t,e){i?e.open():e.close()},this)),this)},t.prototype.keepOnline=function(t){return void 0===t?!!this._options.keepOnline:(this._options.keepOnline!==t&&(this._options.keepOnline=t,this.watchOnline(t)),this)},t.prototype.watchOnline=function(t){"object"==typeof window&&(t?(window.addEventListener("online",this.onOnline),window.addEventListener("offline",this.onOffline)):(window.removeEventListener("online",this.onOnline),window.removeEventListener("offline",this.onOffline)))},t.prototype.onOnline=function(t){this.isOnline(!0)},t.prototype.onOffline=function(t){this.isOnline(!1)},t.prototype.getHost=function(t){return t=y.Uri.fromAny(t),this._hosts.get(t)},t.prototype.openHost=function(t){t=y.Uri.fromAny(t);var e=this._hosts.get(t);return e||(e=new N(this,t,this._options),this._hosts.set(t,e)),e},t.prototype.closeHost=function(t){this._hosts.get(t._hostUri)&&(this._hosts.delete(t._hostUri),t.closeUp())},t.prototype.getDownlink=function(t,e,i){var o=this._downlinks.get(t);if(o){var n=o.get(e);if(n)return n.get(i)}},t.prototype.openDownlink=function(t){var e=t.hostUri(),i=t.nodeUri(),o=t.laneUri(),n=this._downlinks.get(e);n||(n=new y.BTree,this._downlinks.set(e,n));var r=n.get(i);if(r||(r=new y.BTree,n.set(i,r)),r.has(o))throw new Error("duplicate downlink");r.set(o,t),this._downlinkCount+=1,this.openHost(e).openDownlink(t)},t.prototype.unlinkDownlink=function(t){var e=t.hostUri(),i=this.getHost(e);i&&i.unlinkDownlink(t)},t.prototype.closeDownlink=function(t){var e=t.hostUri(),i=t.nodeUri(),o=t.laneUri(),n=this._downlinks.get(e);if(n){var r=n.get(i);if(r&&r.get(o)){this._downlinkCount-=1,r.delete(o),r.isEmpty()&&(n.delete(i),n.isEmpty()&&this._downlinks.delete(e));var s=this.getHost(e);s&&s.closeDownlink(t)}}},t.prototype.downlink=function(t){return new A(this,void 0,t)},t.prototype.downlinkList=function(t){return new C(this,void 0,t)},t.prototype.downlinkMap=function(t){return new x(this,void 0,t)},t.prototype.downlinkValue=function(t){return new O(this,void 0,t)},t.prototype.openRef=function(t){this._refs.push(t)},t.prototype.closeRef=function(t){var e=this._refs.indexOf(t);0<=e&&(this._refs.splice(e,1),t.closeUp())},t.prototype.hostRef=function(t){return t=y.Uri.fromAny(t),new L(this,t)},t.prototype.nodeRef=function(t,e){return t=y.Uri.fromAny(t),e=void 0===e?(t=(e=t).base()).unresolve(e):y.Uri.fromAny(e),new j(this,t,e)},t.prototype.laneRef=function(t,e,i){return t=y.Uri.fromAny(t),e=y.Uri.fromAny(e),void 0===i?(i=e,e=(t=(e=t).base()).unresolve(e)):i=y.Uri.fromAny(i),new P(this,t,e,i)},t.prototype.authenticate=function(t,e){t=y.Uri.fromAny(t),e=y.Value.fromAny(e),this.openHost(t).authenticate(e)},t.prototype.command=function(t,e,i,o){t=y.Uri.fromAny(t),e=y.Uri.fromAny(e),3===arguments.length?(o=i,i=e,e=(t=(e=t).base()).unresolve(e)):i=y.Uri.fromAny(i),o=y.Value.fromAny(o),this.openHost(t).command(e,i,o)},t.prototype.close=function(){var t=this._refs;this._refs=[];for(var e=0;e<t.length;e+=1)t[e].closeUp();var i=this._downlinks.clone();this._downlinks.clear(),this._downlinkCount=0,i.forEach(function(o,t){t.forEach(function(t,e){e.forEach(function(t,e){e.closeUp();var i=this.getHost(o);i&&i.closeDownlink(e)},this)},this)},this);var o=this._hosts.clone();this._hosts.clear(),o.forEach(function(t,e){e.closeUp()},this)},t.prototype.didConnect=function(t){return void 0===t?this.delegate.didConnect||null:(this.delegate.didConnect=t||void 0,this)},t.prototype.didAuthenticate=function(t){return void 0===t?this.delegate.didAuthenticate||null:(this.delegate.didAuthenticate=t||void 0,this)},t.prototype.didDeauthenticate=function(t){return void 0===t?this.delegate.didDeauthenticate||null:(this.delegate.didDeauthenticate=t||void 0,this)},t.prototype.didDisconnect=function(t){return void 0===t?this.delegate.didDisconnect||null:(this.delegate.didDisconnect=t||void 0,this)},t.prototype.didFail=function(t){return void 0===t?this.delegate.didFail||null:(this.delegate.didFail=t||void 0,this)},t.prototype.hostDidConnect=function(t){this.delegate.didConnect&&this.delegate.didConnect(t,this);for(var e=0;e<this._refs.length;e+=1){var i=this._refs[e];i.hostUri().equals(t._hostUri)&&i.hostDidConnect(t)}},t.prototype.hostDidAuthenticate=function(t,e){this.delegate.didAuthenticate&&this.delegate.didAuthenticate(t,e,this);for(var i=0;i<this._refs.length;i+=1){var o=this._refs[i];o.hostUri().equals(e._hostUri)&&o.hostDidAuthenticate(t,e)}},t.prototype.hostDidDeauthenticate=function(t,e){this.delegate.didDeauthenticate&&this.delegate.didDeauthenticate(t,e,this);for(var i=0;i<this._refs.length;i+=1){var o=this._refs[i];o.hostUri().equals(e._hostUri)&&o.hostDidDeauthenticate(t,e)}},t.prototype.hostDidDisconnect=function(t){this.delegate.didDisconnect&&this.delegate.didDisconnect(t,this);for(var e=0;e<this._refs.length;e+=1){var i=this._refs[e];i.hostUri().equals(t._hostUri)&&i.hostDidDisconnect(t)}},t.prototype.hostDidFail=function(t,e){this.delegate.didFail&&this.delegate.didFail(t,e,this);for(var i=0;i<this._refs.length;i+=1){var o=this._refs[i];o.hostUri().equals(e._hostUri)&&o.hostDidFail(t,e)}},t}(),J=new G,Q=J.isOnline.bind(J),X=J.keepOnline.bind(J),Y=J.downlink.bind(J),Z=J.downlinkList.bind(J),$=J.downlinkMap.bind(J),tt=J.downlinkValue.bind(J),et=J.hostRef.bind(J),it=J.nodeRef.bind(J),ot=J.laneRef.bind(J),nt=J.authenticate.bind(J),rt=J.command.bind(J);t.client=J,t.isOnline=Q,t.keepOnline=X,t.downlink=Y,t.downlinkList=Z,t.downlinkMap=$,t.downlinkValue=tt,t.hostRef=et,t.nodeRef=it,t.laneRef=ot,t.authenticate=nt,t.command=rt,t.Envelope=r,t.EventMessage=a,t.CommandMessage=d,t.LinkRequest=u,t.LinkedResponse=p,t.SyncRequest=c,t.SyncedResponse=f,t.UnlinkRequest=_,t.UnlinkedResponse=v,t.AuthRequest=m,t.AuthedResponse=w,t.DeauthRequest=g,t.DeauthedResponse=k,t.RemoteHost=U,t.Downlink=D,t.EventDownlink=A,t.ListDownlink=C,t.ListDownlinkRecord=F,t.MapDownlink=x,t.MapDownlinkRecord=T,t.ValueDownlink=O,t.ValueDownlinkRecord=M,t.HostRef=L,t.NodeRef=j,t.LaneRef=P,t.DownlinkScope=q,t.Client=G,Object.defineProperty(t,"__esModule",{value:!0})});
//# sourceMappingURL=swim-client.min.js.map